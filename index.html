<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blackjack Terminal Game</title>

    <!-- Bootstrap 5.3.3 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Xterm.js CSS CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css"
    />

    <style>
      body {
        background-color: #111;
        color: #fff;
      }

      .terminal-wrapper {
        background-color: #000;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        min-height: 400px; /* updated */
        height: auto; /* auto-expand */
        overflow: hidden; /* updated */
      }

      #terminal {
        width: 100%;
        height: 100%; /* updated */
        font-size: 1rem; /* added */
      }

      .terminal-wrapper {
        overflow-y: hidden; /* disables vertical scrollbar */
      }

      .terminal-wrapper::-webkit-scrollbar {
        display: none;
      }
      .xterm-viewport::-webkit-scrollbar {
        width: 0 !important;
        display: none;
      }

      .xterm-viewport {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
      }

      .btn-custom {
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        #terminal {
          font-size: 0.85rem; /* smaller font on mobile/tablet */
        }

        .terminal-wrapper {
          min-height: 300px;
          padding: 0.75rem;
        }

        .btn-custom .btn {
          width: 100%;
        }
      }

      /* Add Pulse Animation */
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }

      #hitBtn, #standBtn {
        animation: pulse 1.5s infinite ease-in-out;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <h1 class="text-center mb-4">üÉè Blackjack Terminal (Human vs AI)</h1>

      <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-10">
          <div class="terminal-wrapper" id="terminal-container">
            <div id="terminal"></div>
          </div>
          <div class="text-center btn-custom mt-3">
            <button class="btn btn-success mb-2" id="startBtn">Start Game</button>
            <button class="btn btn-secondary mb-2" id="resetStatsBtn">Reset Stats</button>
          </div>
          <div class="text-center mt-3" id="actionButtons" style="display: none;">
            <button class="btn btn-warning me-2" id="hitBtn">Hit</button>
            <button class="btn btn-primary" id="standBtn">Stand</button>
          </div>
          <!-- Add Restart Button -->
          <div class="text-center mt-3" id="restartButton" style="display: none;">
            <button class="btn btn-danger animate__animated" id="restartBtn">üîÅ Restart Game</button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Xterm.js JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.min.js"></script>

    <!-- Game Logic -->
    <script>
      const term = new Terminal();
      term.open(document.getElementById("terminal"));

      function writeTopBar() {
        term.writeln("");
        term.writeln("====================================");
        term.writeln("üé¥ BLACKJACK TERMINAL ‚Äì Human vs AI");
        term.writeln("====================================\n");
      }

      term.writeln("Welcome to Blackjack Terminal Game!");
      term.writeln("Type 'start' to begin or 'help' for commands.");

      // LocalStorage boilerplate
      const defaultStats = {
        totalGames: 0,
        wins: 0,
        losses: 0,
        draws: 0,
        blackjacks: 0,
        balance: 1000, // üíµ Starting balance
      };

      const loadStats = () => {
        const saved = localStorage.getItem("blackjack_stats");
        const stats = saved ? JSON.parse(saved) : { ...defaultStats };
        // Ensure balance is initialized
        if (stats.balance === undefined) stats.balance = 1000;
        return stats;
      };

      const saveStats = (stats) => {
        localStorage.setItem("blackjack_stats", JSON.stringify(stats));
      };

      const resetStats = () => {
        localStorage.removeItem("blackjack_stats");
        term.writeln("üìâ Stats and balance have been reset."); // Updated message
      };

      // Button Events
      $("#startBtn").on("click", () => {
        startGame(); // Call the function to start the game
      });

      $("#resetStatsBtn").on("click", () => {
        resetStats();
      });

      $("#hitBtn").on("click", () => {
        if (gameActive) {
          playerHits();
        }
      });

      $("#standBtn").on("click", () => {
        if (gameActive) {
          playerStands();
        }
      });

      // Add Restart Button Event Listener
      $("#restartBtn").on("click", () => {
        startGame();
      });

      // Deck & Card Logic
      const suits = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"];
      const values = [
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "J",
        "Q",
        "K",
        "A",
      ];

      let deck = [];
      let playerHand = [];
      let dealerHand = [];
      let gameActive = false;
      let currentBet = 0; // Global variable for the current bet
      let awaitingBet = false; // Flag for bet input mode
      let betInputBuffer = ""; // Buffer for bet input

      function createDeck() {
        deck = [];
        for (const suit of suits) {
          for (const value of values) {
            deck.push({ suit, value });
          }
        }
      }

      function shuffleDeck() {
        for (let i = deck.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [deck[i], deck[j]] = [deck[j], deck[i]];
        }
      }

      function drawCard() {
        return deck.pop();
      }

      // Hand Value Logic
      function calculateHandValue(hand) {
        let value = 0;
        let aces = 0;

        for (const card of hand) {
          if (["J", "Q", "K"].includes(card.value)) {
            value += 10;
          } else if (card.value === "A") {
            value += 11;
            aces++;
          } else {
            value += parseInt(card.value);
          }
        }

        // Adjust for Aces
        while (value > 21 && aces > 0) {
          value -= 10;
          aces--;
        }

        return value;
      }

      function renderHand(hand) {
        return hand.map((c) => `[${c.value}${c.suit}]`).join(" ");
      }

      // Game Actions
      function startGame() {
        term.clear(); // üßº Clear screen before new game
        writeTopBar();

        const stats = loadStats(); // Load stats to check balance

        // Check if player has enough balance to play
        if (stats.balance <= 0) {
          term.writeln("üí∏ You're out of money! Reset stats to play again.");
          term.write("> ");
          return;
        }

        // Ask for bet via terminal
        awaitingBet = true;
        betInputBuffer = "";
        term.writeln(`üíµ You have $${stats.balance}. Enter your bet:`);
        term.write("> ");
        // Removed prompt logic and game start logic from here
      }

      function checkPlayerStatus() {
        const playerTotal = calculateHandValue(playerHand);

        if (playerTotal === 21) {
          term.writeln("üéâ Blackjack! Let's see what the dealer does...");
          dealerTurn();
        } else if (playerTotal > 21) {
          term.writeln("üí• Bust! You lose.");
          endGame("loss");
        }
      }

      function playerHits() {
        if (!gameActive) return;
        playerHand.push(drawCard());
        const total = calculateHandValue(playerHand);
        term.writeln(
          "üë§ You drew: " + renderHand([playerHand[playerHand.length - 1]])
        );
        term.writeln(
          "üë§ Your Hand: " + renderHand(playerHand) + ` (Total: ${total})`
        );
        term.writeln("");

        checkPlayerStatus();

        // Only ask again if not busted or blackjack
        if (gameActive) {
          term.writeln("Type 'hit' or 'stand', or use the buttons."); // Updated instruction
          term.write("> "); // Add prompt
        } else {
          $("#actionButtons").hide(); // Hide buttons if game ended (bust)
        }
      }

      function playerStands() {
        if (!gameActive) return;
        term.writeln("üß† You stand. Dealer's turn...");
        term.writeln("");
        dealerTurn();
      }

      function dealerTurn() {
        const reveal = renderHand(dealerHand);
        let dealerTotal = calculateHandValue(dealerHand);

        term.writeln(
          "ü§ñ Dealer reveals: " + reveal + ` (Total: ${dealerTotal})`
        );
        term.writeln("");

        const interval = setInterval(() => {
          if (dealerTotal < 17) {
            const card = drawCard();
            dealerHand.push(card);
            dealerTotal = calculateHandValue(dealerHand);
            term.writeln(
              "ü§ñ Dealer draws: " +
                renderHand([card]) +
                ` ‚Üí Total: ${dealerTotal}`
            );
          } else {
            clearInterval(interval);
            determineWinner();
          }
        }, 1000);
      }

      function determineWinner() {
        const playerTotal = calculateHandValue(playerHand);
        const dealerTotal = calculateHandValue(dealerHand);

        if (dealerTotal > 21 || playerTotal > dealerTotal) {
          term.writeln("‚úÖ You win!");
          endGame("win");
        } else if (dealerTotal > playerTotal) {
          term.writeln("‚ùå Dealer wins!");
          endGame("loss");
        } else {
          term.writeln("ü§ù It's a draw.");
          endGame("draw");
        }
      }

      function endGame(result) {
        gameActive = false;
        $("#actionButtons").hide(); // ‚úÖ Hide hit/stand buttons
        $("#restartButton").show(); // Show restart button
        const stats = loadStats(); // Load stats *before* updating
        stats.totalGames++;

        const playerValue = calculateHandValue(playerHand);
        const isBlackjack = playerValue === 21 && playerHand.length === 2;

        if (result === "win") {
          stats.wins++;
          stats.balance += currentBet * 2; // Win double the bet
          term.writeln(`üí∞ You won $${currentBet * 2}!`);
        } else if (result === "loss") {
          stats.losses++;
          // Bet was already deducted at the start
          term.writeln(`üí∏ You lost $${currentBet}.`);
        } else if (result === "draw") {
          stats.draws++;
          stats.balance += currentBet; // Refund the bet
          term.writeln(`üí∞ Bet refunded ($${currentBet}).`);
        }

        // Bonus for Blackjack
        if (isBlackjack) {
          stats.blackjacks++;
          const bonus = Math.floor(currentBet * 0.5); // +50% bonus for Blackjack
          stats.balance += bonus;
          term.writeln(`üéâ Blackjack bonus: +$${bonus}!`);
        }

        // Update history
        const history =
          JSON.parse(localStorage.getItem("blackjack_history")) || [];
        history.unshift({
          result,
          player: calculateHandValue(playerHand),
          dealer: calculateHandValue(dealerHand),
          bet: currentBet, // Store bet in history
          payout: result === 'win' ? currentBet * 2 + (isBlackjack ? Math.floor(currentBet * 0.5) : 0) : (result === 'draw' ? currentBet : 0), // Store payout
          timestamp: new Date().toLocaleString(),
        });
        if (history.length > 5) history.pop();
        localStorage.setItem("blackjack_history", JSON.stringify(history));

        saveStats(stats); // Save stats *after* calculating payouts and bonus

        term.writeln(`\nüìä Current Balance: $${stats.balance}`); // Show balance after game
        term.writeln("\nüé≤ Game Over.");
        term.writeln("üìä Type 'stats' to view performance.");
        term.writeln("üîÅ Type 'start' to play again.");
        term.write("> "); // Add prompt
      }

      // Command Parser
      let commandBuffer = "";

      term.onData((key) => {
        // Handle bet input if awaiting
        if (awaitingBet) {
          if (key === "\r") { // Enter key
            term.writeln(""); // new line after input
            const stats = loadStats();
            const bet = parseInt(betInputBuffer.trim());

            if (!bet || isNaN(bet) || bet <= 0 || bet > stats.balance) {
              term.writeln(`‚ùå Invalid bet. Must be 1 to $${stats.balance}`);
              term.write("> ");
              betInputBuffer = ""; // Reset buffer for next attempt
              return; // Stop processing, wait for new bet input
            }

            // Valid bet received
            currentBet = bet;
            stats.balance -= currentBet;
            saveStats(stats);
            term.writeln(`üí∞ You bet $${currentBet}. Remaining: $${stats.balance}`);
            awaitingBet = false; // Exit bet input mode
            betInputBuffer = ""; // Clear buffer

            // --- Continue starting the game ---
            createDeck();
            shuffleDeck();

            playerHand = [drawCard(), drawCard()];
            dealerHand = [drawCard(), drawCard()];
            gameActive = true;

            term.writeln("üéÆ Game Started!");
            term.writeln(
              "üë§ Your Hand: " +
                renderHand(playerHand) +
                ` (Total: ${calculateHandValue(playerHand)})`
            );
            term.writeln(
              "ü§ñ Dealer Shows: " + `[${dealerHand[0].value}${dealerHand[0].suit}]`
            );
            term.writeln("Type 'hit' or 'stand', or use the buttons."); // Updated instruction
            term.writeln("");
            term.write("> "); // Add prompt
            $("#actionButtons").show(); // ‚úÖ Show hit/stand buttons
            $("#restartButton").hide(); // Hide restart button if visible
            return; // Bet processed, game started, stop further processing in onData
          }

          // Handle Backspace for bet input
          if (key === "\u007F") {
            if (betInputBuffer.length > 0) {
              betInputBuffer = betInputBuffer.slice(0, -1);
              term.write("\b \b"); // Move cursor back, erase char, move back again
            }
            return; // Stop processing other keys
          }

          // Add typed character (only if it's a digit for bet)
          if (key >= '0' && key <= '9') { // Allow only digits for bet
             betInputBuffer += key;
             term.write(key);
          }
          // Ignore non-digit characters during bet input
          return; // Stop processing other keys/commands while awaiting bet
        }

        // --- Regular command processing (if not awaiting bet) ---

        // If Enter key is pressed
        if (key === "\r") {
          const cmd = commandBuffer.trim().toLowerCase();
          commandBuffer = ""; // reset buffer
          term.writeln(""); // ‚úÖ ensures next output starts on a new line

          // Execute command
          switch (cmd) {
            case "start":
              startGame();
              break;

            case "hit":
              if (gameActive) {
                playerHits();
              } else {
                term.writeln("Game not active. Type 'start' to begin.");
                term.write("> ");
              }
              break;

            case "stand":
              if (gameActive) {
                playerStands();
              } else {
                term.writeln("Game not active. Type 'start' to begin.");
                term.write("> ");
              }
              break;

            case "rules":
              term.clear(); // Clear before showing rules
              writeTopBar();
              term.writeln("üìñ Blackjack Rules:");
              term.writeln("1. Get as close to 21 without going over.");
              term.writeln("2. Face cards = 10. Aces = 1 or 11.");
              term.writeln("3. Type 'hit' to draw, 'stand' to end your turn.");
              term.writeln("4. Dealer hits until 17+. Highest hand wins.");
              term.write("> "); // Add prompt
              break;

            case "stats":
              term.clear(); // Clean view for stats
              writeTopBar();
              const s = loadStats();
              term.writeln("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
              term.writeln("üìä Game Stats:");
              term.writeln("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
              term.writeln(`  Games Played : ${s.totalGames}`);
              term.writeln(`  Wins         : ${s.wins}`);
              term.writeln(`  Losses       : ${s.losses}`);
              term.writeln(`  Draws        : ${s.draws}`);
              term.writeln(`  Blackjacks   : ${s.blackjacks}`);
              term.writeln(`  Balance      : $${s.balance}`); // Display balance
              term.writeln(
                `  Win Rate     : ${
                  s.totalGames > 0
                    ? ((s.wins / s.totalGames) * 100).toFixed(1)
                    : 0
                }%`
              );
              term.writeln("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n");
              term.write("> "); // Add prompt
              break;

            case "history":
              term.clear(); // Clean view for history
              writeTopBar();
              const history =
                JSON.parse(localStorage.getItem("blackjack_history")) || [];
              if (history.length === 0) {
                term.writeln("üì≠ No game history yet.");
              } else {
                term.writeln("üïì Last 5 games:");
                history.forEach((h, i) => {
                  term.writeln(
                    `${i + 1}. ${h.result.toUpperCase()} | You: ${
                      h.player
                    }, Dealer: ${h.dealer} | ${h.timestamp}`
                  );
                });
              }
              term.write("> "); // Add prompt
              break;

            case "reset stats":
              term.clear();
              writeTopBar();
              resetStats(); // resetStats already prints the updated message
              term.write("> "); // Add prompt
              break;

            case "clear":
              term.clear();
              writeTopBar();
              term.writeln("üßº Terminal cleared.");
              term.writeln(
                "Type 'start' to play, 'rules' to view how to play."
              );
              term.write("> "); // Add prompt
              break;

            case "":
              term.write("> "); // Add prompt for empty input
              break; // ignore empty input

            default:
              term.clear(); // Clear before showing error
              writeTopBar();
              term.writeln(`‚ùì Unknown command: '${cmd}'`);
              term.write("> "); // Add prompt
          }

          // // Only show prompt if game is not active or just ended - REMOVED logic, handled in cases now
          // if (
          //   !gameActive ||
          //   [
          //     "start",
          //     "rules",
          //     "stats",
          //     "history",
          //     "reset stats",
          //     "clear",
          //     "",
          //   ].includes(cmd) ||
          //   cmd.startsWith("?")
          // ) {
          //   term.write("\r\n> "); // show prompt
          // }
        }

        // Backspace support
        else if (key === "\u007F") {
          if (commandBuffer.length > 0) {
            commandBuffer = commandBuffer.slice(0, -1);
            term.write("\b \b");
          }
        }

        // Regular character
        else {
          commandBuffer += key;
          term.write(key);
        }
      });

      // Add initial prompt
      term.write("> ");
    </script>

    <!-- How to Play Modal -->
    <div
      class="modal fade"
      id="howToPlayModal"
      tabindex="-1"
      aria-labelledby="howToPlayLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content text-dark">
          <div class="modal-header">
            <h5 class="modal-title" id="howToPlayLabel">
              How to Play Blackjack
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>üéØ The goal is to get as close to 21 without going over.</p>
            <ul>
              <li>Face cards = 10</li>
              <li>Ace = 1 or 11</li>
              <li>Type <code>hit</code> to draw a card</li>
              <li>Type <code>stand</code> to end your turn</li>
              <li>Dealer hits until 17+</li>
            </ul>
            <p>üí• Bust = total over 21. Highest hand wins!</p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
